const { expect } = require('chai');
const { startApiBuilder, stopApiBuilder } = require('./_base');
const request = require('request');

describe('Endpoints', function () {
	this.timeout(30000);
	let server;

	/**
	 * Start API Builder.
	 */
	before(() => {
		server = startApiBuilder();
		return server.started;
	});

	/**
	 * Stop API Builder after the tests.
	 */
	after(() => stopApiBuilder(server));

	describe('Greet', () => {
		it('[Endpoint-0001] should be able to hit Greet endpoint', (done) => {
			const auth = {
				user: 'test',
				password: ''
			};
			const username = 'Johhny Test';
			request({
				method: 'GET',
				uri: `http://localhost:${server.arrow.port}/api/greet?username=${username}`,
				auth: auth,
				json: true
			}, (err, response, result) => {
				expect(response.statusCode).to.equal(200);
				expect(result).to.equal(`Howdy ${username}`);
				done();
			});
		});

		it('[Endpoint-0002] should be able to get error response from Greet endpoint', (done) => {
			const auth = {
				user: 'test',
				password: ''
			};
			request({
				method: 'GET',
				uri: `http://localhost:${server.arrow.port}/api/greet`,
				auth: auth,
				json: true
			}, (err, response) => {
				expect(response.statusCode).to.equal(400);
				done();
			});
		});
	});
});
